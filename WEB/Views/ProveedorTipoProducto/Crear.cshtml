@model ET.ProveedorTipoProducto
@{
    ViewBag.Title = "Crear";
    Layout = "~/Views/Shared/_Layout.cshtml";
}


<div class="row bg-light p-3 mt-auto align-items-center text-center">
    <div class="row bg-light p-3 mt-auto align-items-center text-center">
        <div class="col-md-2">
            <a href="@Url.Action("Crear", "ProveedorTipoProducto")" class="btn btn-success">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-plus" viewBox="0 0 16 16">
                    <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                </svg>
                Enlazar
            </a>
        </div>
        <div class="col-md-2">
            <a href=" @Url.Action("Index", "ProveedorTipoProducto") " class="btn btn-light">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-file-earmark-plus" viewBox="0 0 16 16">
                    <path d="M8 6.5a.5.5 0 0 1 .5.5v1.5H10a.5.5 0 0 1 0 1H8.5V11a.5.5 0 0 1-1 0V9.5H6a.5.5 0 0 1 0-1h1.5V7a.5.5 0 0 1 .5-.5z" />
                    <path d="M14 4.5V14a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V2a2 2 0 0 1 2-2h5.5L14 4.5zm-3 0A1.5 1.5 0 0 1 9.5 3V1H4a1 1 0 0 0-1 1v12a1 1 0 0 0 1 1h8a1 1 0 0 0 1-1V4.5h-2z" />
                </svg>
                Lista
            </a>
        </div>
        <div class="col-md-2">
            <button class="btn btn-light disabled">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-arrow-repeat" viewBox="0 0 16 16">
                    <path d="M11.534 7h3.932a.25.25 0 0 1 .192.41l-1.966 2.36a.25.25 0 0 1-.384 0l-1.966-2.36a.25.25 0 0 1 .192-.41zm-11 2h3.932a.25.25 0 0 0 .192-.41L2.692 6.23a.25.25 0 0 0-.384 0L.342 8.59A.25.25 0 0 0 .534 9z" />
                    <path fill-rule="evenodd"
                          d="M8 3c-1.552 0-2.94.707-3.857 1.818a.5.5 0 1 1-.771-.636A6.002 6.002 0 0 1 13.917 7H12.9A5.002 5.002 0 0 0 8 3zM3.1 9a5.002 5.002 0 0 0 8.757 2.182.5.5 0 1 1 .771.636A6.002 6.002 0 0 1 2.083 9H3.1z" />
                </svg>
                Actualizar
            </button>
        </div>
        <div class="col-md-2">
            <button class="btn btn-light disabled" data-bs-toggle="modal" data-bs-target="#staticBackdrop">
                <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor"
                     class="bi bi-x" viewBox="0 0 16 16">
                    <path d="M4.646 4.646a.5.5 0 0 1 .708 0L8 7.293l2.646-2.647a.5.5 0 0 1 .708.708L8.707 8l2.647 2.646a.5.5 0 0 1-.708.708L8 8.707l-2.646 2.647a.5.5 0 0 1-.708-.708L7.293 8 4.646 5.354a.5.5 0 0 1 0-.708z" />
                </svg>
                Eliminar
            </button>
        </div>

        <div class="col-md-2 offset-md-1 col-sm-3 offset-sm-1">
            <button type="button" class="btn btn-danger">Cerrar Sesion</button>
        </div>
    </div>
</div>


<div class="row p-3">

    <div class="row">

        <h2 class="ms-4 mb-5">Enlazar Proveedor con su Tipo Producto</h2>

    </div>
    @using (Html.BeginForm("Crear", "ProveedorTipoProducto", FormMethod.Post, new { id = "frmProveedorTipoProducto" }))
    {
        



        <div class="row mt-5">

            <div class="col-1"></div>
           

            <div class="col-10">
                <div class="row">
                    <div class="col-6">

                        <div class="row pb-5">

                            <label for="colFormLabel" class="col-sm-3 col-form-label col-form-label fs-6">Proveedor *</label>
                            <div class="col-sm-5">
                                <select class="form-select" id="idProveedores" name="idProveedor">
                                    <option value="">Escoger...</option>

                                </select>
                                <input type="hidden" name="idProveedor" id="idProveedor" value=""/>
                            </div>

                        </div>

                        <div class="row my-4">

                            <label for="colFormLabel" class="col-sm-3 col-form-label col-form-label fs-6">Tipo Producto *</label>
                            <div class="col-sm-5">
                                <select class="form-select" id="idTiposProducto" name="idTipoProducto">
                                    <option value="">Escoger...</option>

                                </select>

                            </div>

                            <div class="col-1">
                                <a class="btn btn-outline-success btn-sm" id="btnAgregar">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="1.5rem" height="1.5rem" fill="currentColor"
                                         class="bi bi-plus" viewBox="0 0 16 16">
                                        <path d="M8 4a.5.5 0 0 1 .5.5v3h3a.5.5 0 0 1 0 1h-3v3a.5.5 0 0 1-1 0v-3h-3a.5.5 0 0 1 0-1h3v-3A.5.5 0 0 1 8 4z" />
                                    </svg>

                                </a>
                            </div>

                        </div>

                    </div>

                    <div class="col-6">

                        <ul class="list-group">
                        </ul>

                    </div>

                </div>
                <div class="row pt-3">
                    <div class="offset-2 col-md-2">
                        <div class="d-grid gap-2">
                            <a value="Borrar" id="btnBorrar" class="btn btn-danger">Borrar</a>
                        </div>
                    </div>
                    <div class=" col-md-4">
                        <div class="d-grid gap-2">
                            <button id="btnEnviar" type="submit" value="Crear" class="btn btn-success">Crear</button>
                        </div>
                    </div>

                </div>



            </div>

            <div class="col-1"></div>

        </div>
     }
</div>

<!-- Toast -->

<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 11">
    <div id="liveToastCrear" class="toast fade hide" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="toast-header">

            <svg class="bd-placeholder-img rounded me-2" width="20" height="20" xmlns="http://www.w3.org/2000/svg"
                 aria-hidden="true" preserveAspectRatio="xMidYMid slice" focusable="false">
                <rect width="100%" height="100%" fill="#007aff"></rect>
            </svg>

            <strong class="me-auto">Del sistema</strong>
            <small>Hace 3 seg</small>
            <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close" onclick="CerrarToast()"></button>
        </div>
        <div id="toast-bodyCrearUM" class="toast-body">

        </div>
    </div>
</div>

<script>
    var tipoProductos = [];
    var datosAjax = []
    $("#btnAgregar").click(function () {

        //agarrar el valor de cada uno de ellos
        var idProveedor = $("#idProveedores");
        var idTipoProducto = $("#idTiposProducto").children("option:selected");

        console.log(idTipoProducto.val());
        if (idTipoProducto[0].innerText == "Escoger..." || idProveedor.children("option:selected")[0].innerText == "Escoger...") {

            var msg = "Seleccione un proveedor y un Tipo de Producto";
            LlenarMensajeErrorToastCrearEditar(msg);
        } else {
            var pasa = true;
            //como el select si lo dejo en disabled no me trae su valor, voy a crear un input escondido que tenga el mismo valor.
            

            idProveedor.attr("disabled", "");

            tipoProductos.forEach(id => {

                if (id == idTipoProducto.val()) {
                    pasa = false;
                }
            });

            if (pasa == true) {
                var listGroup = "<li class='list-group-item' value= '" + idTipoProducto.val() + "'>" + idTipoProducto[0].innerText + "</li>";

                $(".list-group").append(listGroup)//meterlo en la lista
                tipoProductos.push(idTipoProducto.val()); //almaceno los tp IDs
                $("#idProveedor").val(idProveedor.val()); //el input escondido
                datosAjax.push($("#frmProveedorTipoProducto").serializeArray()); //tener el formato bien para el controlador
               
                
            } else {
                var msg = idTipoProducto[0].innerText + " ya está registrado";
                LlenarMensajeErrorToastCrearEditar(msg);
            }
        }

        console.log(tipoProductos);
        console.log(datosAjax);
    });

    $("#btnBorrar").click(function () {

        var idProveedor = $("#idProveedores");
        tipoProductos = [];
        datosAjax = [];
        $(".list-group").empty();

        idProveedor.removeAttr("disabled");
        $("#idProveedor").val('0');

        console.log($("#idProveedor").val());
    })

    var repetido = false;
    var noRepetido = false;
    var cont = 0;
    var response1;
    var response2; 
    function Ver() {
        cont++;
        debugger;
        if (cont == datosAjax.length) { //si ya lo llamo la misma cantidad de veces, para poder saber si por lo menos hay uno repetido
             //boton editar o crear
            var textoBoton = $("#btnEnviar").val();
            if (repetido == false && noRepetido == true) {
                debugger;

                if (textoBoton == "Crear") {
                    AgarrarDescripcionEnlaces("enlace/s","creó/crearon", response1);
                } else {
                    if (textoBoton == "Editar") {
                        AgarrarDescripcionEnlaces("enlace/s","actualizó/actualizaron", response1);
                    }
                }

            } else if (repetido == true && noRepetido == true) {
                debugger;
                if (textoBoton == "Crear") {
                    AgarrarDescripcionEnlaces("algunos enlaces","creó/crearon", response2);
                } else {
                    if (textoBoton == "Editar") {
                        AgarrarDescripcionEnlaces("algunos enlaces","actualizó/actualizaron", response2);
                    }
                }


            } else if (repetido == true && noRepetido == false) {
                debugger;
                var msg = "Un enlace/s de los creados ya existe";
                EsconderMostrarToast(msg);


            }
        }

    }

    $("#frmProveedorTipoProducto").submit(function (event) {

        event.preventDefault();
        //variables
        var idProveedor = $("#idProveedores");

        if (idProveedor.children("option:selected")[0].innerText == "Escoger..." ) {
            var msg = "Faltan datos por agregar (*)";
            LlenarMensajeErrorToastCrearEditar(msg);

        } else { //todo bien
               
                datosAjax.forEach(data => {
                    debugger;
                    //console.log(datos);
                    var post_url = $(this).attr("action"); //get form action url, voy a almacenar el action que se va a ejecutar
                    var request_method = $(this).attr("method"); //get form GET/POST method, el metodo que yo voy a ejecutar, el post
                    var form_data = data //Encode form elements for submission, datos del formulario serializado, es el json
                    //console.log($(datos).serializeArray());
                  
                    $.ajax({
                        url: post_url,
                        type: request_method, //tipo del metodo
                        data: form_data //los datos recopilados
                    }).done(function (response) {

                        if (response.ok == 1) {//todo bien
                            noRepetido = true;
                            response1 = response.toRedirect;
                        }
                        else if (response.ok == 2) {
                            repetido = true;
                            response2 = response.toRedirect;
                        } else {

                            var msg = response.msg

                            EsconderMostrarToast(msg)
                        }

                        Ver();
                    }).fail(function (data) {

                        alert(data.responseText);
                       // var msg = "Ocurrio un error en el ajax: " + data.responseText;
                        //LlenarMensajeErrorToastCrearEditar(msg)

                    });

                });

           
        }

    })

    function AgarrarDescripcionEnlaces(desc,crud, toRedirect) { //crud me refiero si es crear o editar nada mas

        

        MensajeToastIndex(desc, crud);

        window.location.href = toRedirect;
    }
</script>
